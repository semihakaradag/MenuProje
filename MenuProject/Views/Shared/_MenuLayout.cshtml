@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@inject UserManager<IdentityUser> UserManager
@inject IHttpContextAccessor HttpContextAccessor
@inject MenuProject.Data.MenuDbContext _context

@{
    var user = HttpContextAccessor.HttpContext.User;

    // Kullanıcının sahip olduğu yetkileri claim'lerden çek (Format: "ControllerName/ActionName")
    var menuClaims = user.Claims
                         .Where(c => c.Type == "Menu")
                         .Select(c => c.Value)
                         .ToList();
    var allMenus = _context.UserMenus
                        .Where(m => m.IsVisible == true)
                        .OrderBy(m => m.SortNumber)
                        .ToList(); // 📌 Verileri belleğe al

    Console.WriteLine("Menülerin toplam sayısı: " + allMenus.Count);

    // 📌 Menüler Claim'deki formata uygun mu?
    var mainMenus = allMenus
                    .Where(m => m.ParentId == null &&
                                menuClaims.Contains($"{m.ControllerName}/{m.ActionName}/{m.Name}"))
                    .ToList();

    Console.WriteLine("Ana menülerin sayısı: " + mainMenus.Count);

    var subMenus = allMenus
                    .Where(m => m.ParentId != null &&
                                menuClaims.Contains($"{m.ControllerName}/{m.ActionName}/{m.Name}"))
                    .ToList();

    Console.WriteLine("Alt menülerin sayısı: " + subMenus.Count);

}
<style>
    .sidebar {
        display: flex;
        flex-direction: column;
        height: 100vh;
    }

        .sidebar .nav {
            flex-grow: 1;
        }

        .sidebar .nav-item:last-child {
            margin-top: auto;
        }

</style>
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - MenuProject</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="d-flex">
        <!-- 🔥 Sidebar Başlangıç -->
        <nav class="sidebar bg-dark text-white p-3 vh-100" style="width: 250px;">
            <h4 class="text-center">Menü</h4>
            <ul class="nav flex-column">
                @foreach (var menu in mainMenus)
                {
                    var subMenuItems = subMenus.Where(sm => sm.ParentId == menu.Id).ToList();

                    <li class="nav-item">
                        <a class="nav-link text-white" href="@Url.Action(menu.ActionName, menu.ControllerName)">
                            <i class="@menu.Icon"></i> @menu.Name
                        </a>

                        @if (subMenuItems.Any()) // Eğer alt menüler varsa
                        {
                            <ul class="nav flex-column ms-3">
                                @foreach (var subMenu in subMenuItems)
                                {
                                    <li class="nav-item">
                                        <a class="nav-link text-white" href="@Url.Action(subMenu.ActionName, subMenu.ControllerName)">
                                            <i class="@subMenu.Icon"></i> @subMenu.Name
                                        </a>
                                    </li>
                                }
                            </ul>
                        }
                    </li>
                }
            </ul>
                <!-- 🔥 Çıkış Yap Butonu -->
                <form asp-controller="Account" asp-action="Logout" method="post">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                    </button>
                </form>
            
        </nav>
        <!-- 🔥 Sidebar Bitiş -->
        <!-- Ana İçerik Alanı -->
        <div class="container-fluid p-4">
            <main role="main">
                @RenderBody()
            </main>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
