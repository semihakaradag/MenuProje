@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@inject UserManager<IdentityUser> UserManager
@inject IHttpContextAccessor HttpContextAccessor
@inject MenuProject.Data.MenuDbContext _context

@{
    var user = HttpContextAccessor.HttpContext.User;

    // Kullanıcının sahip olduğu yetkileri claim'lerden çek (Format: "ControllerName/ActionName")
    var menuClaims = user.Claims
                         .Where(c => c.Type == "Menu")
                         .Select(c => c.Value)
                         .ToList();
    var allMenus = _context.UserMenus
                        .Where(m => m.IsVisible == true)
                        .OrderBy(m => m.SortNumber)
                        .ToList(); // 📌 Verileri belleğe al

    Console.WriteLine("Menülerin toplam sayısı: " + allMenus.Count);

    // 📌 Menüler Claim'deki formata uygun mu?
    var mainMenus = allMenus
                    .Where(m => m.ParentId == null &&
                                menuClaims.Contains($"{m.ControllerName}/{m.ActionName}/{m.Name}"))
                    .ToList();

    Console.WriteLine("Ana menülerin sayısı: " + mainMenus.Count);

    var subMenus = allMenus
                    .Where(m => m.ParentId != null &&
                                menuClaims.Contains($"{m.ControllerName}/{m.ActionName}/{m.Name}"))
                    .ToList();

    Console.WriteLine("Alt menülerin sayısı: " + subMenus.Count);

}
<style>
    .sidebar {
        display: flex;
        flex-direction: column;
        height: 100vh;
    }

        .sidebar .nav {
            flex-grow: 1;
        }

        .sidebar .nav-item:last-child {
            margin-top: auto;
        }

    .dropdown-menu {
        background-color: #ffffff !important; /* Beyaz arka plan */
        border: none;
    }

    .dropdown-item {
        color: black !important;
    }

        .dropdown-item:hover {
            background-color: rgba(0, 0, 0, 0.1); /* Hafif gri hover efekti */
        }
</style>
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - MenuProject</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="d-flex">
        <!-- 🔥 Sidebar Başlangıç -->
        <nav class="sidebar bg-dark text-white p-3 vh-100" style="width: 250px;" id="sidebar-menu">
            <h4 class="text-center">Menü</h4>
            <ul class="nav flex-column">
                @foreach (var menu in mainMenus)
                {
                    var subMenuItems = subMenus.Where(sm => sm.ParentId == menu.Id).ToList();
                    var url = menu.ControllerName == "Admin"
                    ? Url.Action(menu.ActionName, menu.ControllerName, new { area = "Admin" })
                    : Url.Action(menu.ActionName, menu.ControllerName);

                    if (subMenuItems.Any()) // Eğer alt menü varsa dropdown yap
                    {
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-white" href="#" id="menu-@menu.Id" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="@menu.Icon"></i> @menu.Name
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="menu-@menu.Id">
                                @foreach (var subMenu in subMenuItems)
                                {
                                    var subUrl = subMenu.ControllerName == "Admin"
                                    ? Url.Action(subMenu.ActionName, subMenu.ControllerName, new { area = "Admin" })
                                    : Url.Action(subMenu.ActionName, subMenu.ControllerName);

                                    <li>
                                        <a class="dropdown-item" href="@subUrl">
                                            <i class="@subMenu.Icon"></i> @subMenu.Name
                                        </a>
                                    </li>
                                }
                            </ul>
                        </li>
                    }
                    else // Normal menü (alt menüsü yoksa)
                    {
                        <li class="nav-item">
                            <a class="nav-link text-white" href="@url">
                                <i class="@menu.Icon"></i> @menu.Name
                            </a>
                        </li>
                    }
                 }
            </ul>
                <!-- 🔥 Çıkış Yap Butonu -->
                <form asp-controller="Account" asp-action="Logout" asp-area="" method="post">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                    </button>
                </form>
            
        </nav>
        <!-- 🔥 Sidebar Bitiş -->
        <!-- Ana İçerik Alanı -->
        <div class="container-fluid p-4">
            <main role="main">
                @RenderBody()
            </main>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $("#editForm").submit(function (event) {
                event.preventDefault(); // Sayfanın normal submit olmasını engelle

                var formData = $(this).serialize();
                $.ajax({
                    url: $(this).attr("action"),
                    type: "POST",
                    data: formData,
                    success: function (response) {
                        // **Eğer başarılı ise Dashboard'a yönlendir**
                        window.location.href = "/Admin/Dashboard/Index";
                    },
                    error: function () {
                        alert("İşlem sırasında bir hata oluştu.");
                    }
                });
            });
        });
    </script>



</body>
</html>
